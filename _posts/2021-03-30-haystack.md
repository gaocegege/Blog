---
layout: post
title: "随时弃坑的论文推荐系列第 2 期：Finding a needle in Haystack: Facebook’s photo storage"
description: 
headline:
modified: 2021-03-30
category: 
tags: []
imagefeature:
mathjax: false
chart:
comments: true
featured: true
---

随着年龄的增加，能够留给自己的时间越来越少。大部分时间都贡献给了工作、家庭和其他各种各样的事务。能够静下心来阅读论文、书籍的机会变得越来越宝贵。这一系列希望能够介绍个人在阅读论文的过程[1]中比较令我印象深刻的论文。不知道能够坚持多少期，且看且珍惜 :-)

今天的文章是 [Haystack][]。它是由 Facebook 发表在 OSDI'10 的一篇文章，主要介绍了 Facebook 的海量图片存储系统。[chrislusf/seaweedfs][] 是对应的开源实现。

之所以选择这篇文章，缘起于 TKE 云原生 AI 团队在每个双周的周五进行的技术交流与讨论。2021 年 4 月 2 日的例行技术分享终于轮到我了，而在我熟悉的集群调度领域，近期没有看到亮眼的论文。因此挑选了一篇跟 AI 业务有关系的存储方向的论文。虽然 [Haystack][] 的设计初衷是支持 Facebook 海量图片存储需求，但是在 CV 领域也被广泛地用于存储训练样本。

## 动机

首先我们来看一下，为什么 Facebook 要专门为了图片存储造一个新轮子。

在典型的用户访问图片数据的场景下的架构。当一个用户访问页面时，首先会向服务器发送 HTTP 请求，获得对应的响应。如果响应中包含着图片的 URL，则会通过新的 HTTP 请求拉取图片。一般而言，对于图片等资源的请求会经过 CDN。如果 CDN 缓存了对应的图片，则直接返回。如果没有则追溯到源服务器，将源图片资源拉取到本地，再返回给用户浏览器。

<figure>
	<img src="{{ site.url }}/images/haystack/typical.png" height="300" width="300">
    <figcaption>典型设计</figcaption>
</figure>

这里也简单介绍下 CDN 的原理。如果没有 CDN，访问一个页面的流程如下：

<figure>
	<img src="{{ site.url }}/images/haystack/withoutcdn.png" height="300" width="300">
    <figcaption>典型页面访问的域名解析过程</figcaption>
</figure>

客户端会在本地 hosts 缓存、本地 DNS、根 DNS、顶级域 DNS、权威 DNS 不同层级依次尝试解析。最终解析的结果由本地 DNS 发送给客户端。而如果配合 CDN，需要借助 DNS 轮询时的 GSLB（Global Server Load Balance，全局服务负载均衡） 和 SLB（Server Load Balance，服务负载均衡） 来完成整个过程。GSLB 会根据本地 DNS 的 IP 判断客户端所在的位置，随后解析到距离客户端比较近的 SLB。SLB 会根据集群中负载情况，将请求重定向到对应的服务器上，处理请求。

<figure>
	<img src="{{ site.url }}/images/haystack/withcdn.png" height="300" width="300">
    <figcaption>CDN 过程</figcaption>
</figure>

但是，这样的设计不满足 Facebook 这样的社交网站的访问特点。CDN 能够很好地满足冷热数据明显的场景，热数据可以被缓存在 CDN 中以更快的速度进行分发。但是在社交媒体的场景下，数据的冷热不明显，经常有用户会访问很久之前的图片。因此，Facebook 采取了基于 NFS 的设计。

<figure>
	<img src="{{ site.url }}/images/haystack/nfs.png" height="300" width="300">
    <figcaption>基于 NFS 的设计</figcaption>
</figure>

Facebook 引入了一个新的概念 Photo Store Server，图片被存储在其后的网络存储中。每个请求在击穿 CDN 后，会由 Photo Store Server 根据图片所在的卷和全路径，读出数据，返回给客户端。在最早的时候，Facebook 会把图片放在一个卷的目录内。每个目录内大约有数千个图片文件。这样会导致一次文件读有 10 次磁盘操作。将每个目录下的文件数量降低到几百个后，读操作会有 3 次磁盘操作。虽然访问操作的次数减少了很多，但是相比于理论最优情况的 1 次，还有较大差距。

# 参考文献

- [CDN原理简析](https://juejin.cn/post/6844903873518239752)

## License

- This article is licensed under [CC BY-NC-SA 3.0](https://creativecommons.org/licenses/by-nc-sa/3.0/).
- Please contact me for commercial use.

[Haystack]: https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Beaver.pdf?spm=a2c4e.11153940.blogcont37396.240.7c5c7b91q08hHy&file=Beaver.pdf
[chrislusf/seaweedfs]: https://github.com/chrislusf/seaweedfs